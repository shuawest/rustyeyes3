use anyhow::Result;
use nokhwa::{
    query,
    frame_format::FrameFormat,
    CameraIndex, Nokhwa,
};

#[tokio::main]
async fn main() -> Result<()> {
    // Initialize the context
    let context = Nokhwa::new()?;

    // Get all available cameras
    let mut devices: Vec<CameraIndex> = query(&context).await?;

    if devices.is_empty() {
        println!("No camera devices found");
        return Ok(());
    }

    println!("Available camera devices:");
    for (i, device) in devices.iter().enumerate() {
        // Get device information
        let info = device.info().await?;

        // Try to get a preview frame to confirm the device works
        let mut handle: Option<nokhwa::Camera> = None;
        let mut preview_frame: Option<&[u8]> = None;

        if let Ok(cam) = context.open(*device) {
            if let Ok(_) =
                cam.set_frame_format(
                    &FrameFormat::mjpg(640, 480)
                )
            {
                if let Ok(frame) = cam.capture_frame().await {
                    preview_frame = Some(frame);
                }
            }
            handle = Some(cam);
        }

        // Print device information
        println!();
        println!("  {} - {}", i + 1, info.name);
        println!("     Vendor: {}", info.vendor);
        println!("     Model: {}", info.model);
        println!("     Path: {}", info.path);

        if let Some(_) | _frame=preview_frame {
            println!("     [Device is working]");
        } else {
            println!("     [Device may not be working]");
        }
    }

    Ok(())
}

