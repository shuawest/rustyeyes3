/// A standard 5x8 bitmap font.
/// Encodings are 5 bytes per character (columns), each byte is a vertical strip of 8 pixels (LSB=top).
/// This is compatible with standard LCD controller fonts or similar.
/// Wait, let's stick to row-based because my drawing logic is row-based.
///
/// 5x7 Font (Row based):
/// Each character is 7 rows. Each row is 5 bits wide (contained in u8).
///
/// We will support a larger subset of ASCII.

pub const FONT_WIDTH: usize = 5;
pub const FONT_HEIGHT: usize = 7;

pub fn measure_text_width(text: &str, scale: usize) -> usize {
    text.len() * ((FONT_WIDTH * scale) + scale)
}

pub fn draw_text_line(buffer: &mut [u8], width: usize, height: usize, x: usize, y: usize, text: &str, color: (u8, u8, u8), scale: usize) {
    let mut cx = x;
    for c in text.chars() {
        draw_char(buffer, width, height, cx, y, c, color, scale);
        cx += (FONT_WIDTH * scale) + scale;
    }
}

fn draw_char(buffer: &mut [u8], width: usize, height: usize, x: usize, y: usize, c: char, color: (u8, u8, u8), scale: usize) {
    let map = get_bitmap(c);
    
    for (row, bits) in map.iter().enumerate() {
        // Iterate bits from MSB (bit 4) to LSB (bit 0) for 5-pixel width
        for col in 0..5 {
            if (bits >> (4 - col)) & 1 == 1 {
                // Draw scaled pixel
                for dy in 0..scale {
                    for dx in 0..scale {
                        let px = x + (col * scale) + dx;
                        let py = y + (row * scale) + dy;
                        if px < width && py < height {
                            let idx = (py * width + px) * 3;
                            if idx + 2 < buffer.len() {
                                buffer[idx] = color.0;
                                buffer[idx+1] = color.1;
                                buffer[idx+2] = color.2;
                            }
                        }
                    }
                }
            }
        }
    }
}

fn get_bitmap(c: char) -> [u8; 7] {
    match c.to_ascii_uppercase() {
        'A' => [0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],
        'B' => [0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E],
        'C' => [0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E],
        'D' => [0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E],
        'E' => [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F],
        'F' => [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10],
        'G' => [0x0E, 0x11, 0x10, 0x13, 0x11, 0x11, 0x0E],
        'H' => [0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],
        'I' => [0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],
        'J' => [0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C],
        'K' => [0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11],
        'L' => [0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F],
        'M' => [0x11, 0x1B, 0x15, 0x11, 0x11, 0x11, 0x11],
        'N' => [0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11],
        'O' => [0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
        'P' => [0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10],
        'Q' => [0x0E, 0x11, 0x11, 0x11, 0x15, 0x09, 0x16],
        'R' => [0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11],
        'S' => [0x0E, 0x11, 0x10, 0x0E, 0x01, 0x11, 0x0E],
        'T' => [0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],
        'U' => [0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
        'V' => [0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04],
        'W' => [0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0A],
        'X' => [0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11],
        'Y' => [0x11, 0x11, 0x11, 0x0A, 0x04, 0x04, 0x04],
        'Z' => [0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F],
        '0' => [0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E],
        '1' => [0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E],
        '2' => [0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F],
        '3' => [0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E],
        '4' => [0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02],
        '5' => [0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E],
        '6' => [0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E],
        '7' => [0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08],
        '8' => [0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E],
        '9' => [0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C],
        '[' => [0x0E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E],
        ']' => [0x0E, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0E],
        '(' => [0x04, 0x08, 0x10, 0x10, 0x10, 0x08, 0x04],
        ')' => [0x04, 0x02, 0x01, 0x01, 0x01, 0x02, 0x04],
        ':' => [0x00, 0x0C, 0x0C, 0x00, 0x0C, 0x0C, 0x00],
        ',' => [0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x04], // low comma
        _   => [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    }
}
